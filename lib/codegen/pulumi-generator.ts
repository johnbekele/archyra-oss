import { Node, Edge } from 'reactflow';
import { ServiceNodeData } from '@/lib/stores/designer-store';
import { getServiceById } from '@/lib/aws-services';

export type PulumiLanguage = 'typescript' | 'python';

export interface PulumiFile {
  path: string;
  content: string;
}

export interface PulumiProject {
  files: PulumiFile[];
  language: PulumiLanguage;
}

// Generate modular Pulumi project
export function generatePulumiProject(
  nodes: Node<ServiceNodeData>[],
  edges: Edge[],
  language: PulumiLanguage = 'typescript'
): PulumiProject {
  if (language === 'python') {
    return generatePulumiProjectPython(nodes, edges);
  }
  return generatePulumiProjectTypeScript(nodes, edges);
}

// Generate TypeScript Pulumi project
function generatePulumiProjectTypeScript(
  nodes: Node<ServiceNodeData>[],
  edges: Edge[]
): PulumiProject {
  const files: PulumiFile[] = [];

  if (nodes.length === 0) {
    files.push({
      path: 'index.ts',
      content: `// No resources to generate
// Drag AWS services onto the canvas to create your architecture`,
    });
    return { files, language: 'typescript' };
  }

  // Generate Pulumi.yaml
  files.push({
    path: 'Pulumi.yaml',
    content: generatePulumiYaml(),
  });

  // Generate package.json
  files.push({
    path: 'package.json',
    content: generatePackageJson(nodes),
  });

  // Generate tsconfig.json
  files.push({
    path: 'tsconfig.json',
    content: generateTsConfig(),
  });

  // Generate component files for each service type
  const serviceTypes = new Set(nodes.map((n) => n.data.serviceId));

  serviceTypes.forEach((serviceId) => {
    const componentFile = generateComponentFile(serviceId);
    files.push({
      path: `components/${serviceId}.ts`,
      content: componentFile,
    });
  });

  // Generate index.ts (main entry)
  files.push({
    path: 'index.ts',
    content: generateIndexTs(nodes, edges),
  });

  // Generate README
  files.push({
    path: 'README.md',
    content: generateReadme(nodes, 'typescript'),
  });

  return { files, language: 'typescript' };
}

// Generate Python Pulumi project
function generatePulumiProjectPython(
  nodes: Node<ServiceNodeData>[],
  edges: Edge[]
): PulumiProject {
  const files: PulumiFile[] = [];

  if (nodes.length === 0) {
    files.push({
      path: '__main__.py',
      content: `# No resources to generate
# Drag AWS services onto the canvas to create your architecture`,
    });
    return { files, language: 'python' };
  }

  // Generate Pulumi.yaml for Python
  files.push({
    path: 'Pulumi.yaml',
    content: generatePulumiYamlPython(),
  });

  // Generate requirements.txt
  files.push({
    path: 'requirements.txt',
    content: generateRequirementsTxt(),
  });

  // Generate component files for each service type
  const serviceTypes = new Set(nodes.map((n) => n.data.serviceId));

  // Generate components/__init__.py
  files.push({
    path: 'components/__init__.py',
    content: generatePythonComponentInit(Array.from(serviceTypes)),
  });

  serviceTypes.forEach((serviceId) => {
    const componentFile = generatePythonComponentFile(serviceId);
    const filename = getPythonFilename(serviceId);
    files.push({
      path: `components/${filename}.py`,
      content: componentFile,
    });
  });

  // Generate __main__.py (main entry)
  files.push({
    path: '__main__.py',
    content: generatePythonMain(nodes, edges),
  });

  // Generate README
  files.push({
    path: 'README.md',
    content: generateReadme(nodes, 'python'),
  });

  return { files, language: 'python' };
}

// Legacy single-file export for preview
export function generatePulumi(
  nodes: Node<ServiceNodeData>[],
  edges: Edge[],
  language: PulumiLanguage = 'typescript'
): string {
  const project = generatePulumiProject(nodes, edges, language);
  const commentPrefix = language === 'python' ? '#' : '//';
  return project.files.map((f) => `${commentPrefix} === ${f.path} ===\n${f.content}`).join('\n\n');
}

function sanitizeName(name: string): string {
  return name.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/^[0-9]/, '_$&');
}

function toPascalCase(str: string): string {
  return str
    .split(/[-_]/)
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join('');
}

function generatePulumiYaml(): string {
  return `name: archyra-infrastructure
runtime: nodejs
description: Infrastructure generated by Archyra Architecture Designer

config:
  aws:region:
    default: us-east-1
`;
}

function generatePackageJson(nodes: Node<ServiceNodeData>[]): string {
  return `{
  "name": "archyra-infrastructure",
  "version": "1.0.0",
  "description": "Infrastructure generated by Archyra Architecture Designer",
  "main": "index.ts",
  "scripts": {
    "build": "tsc"
  },
  "dependencies": {
    "@pulumi/pulumi": "^3.0.0",
    "@pulumi/aws": "^6.0.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "typescript": "^5.0.0"
  }
}
`;
}

function generateTsConfig(): string {
  return `{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "outDir": "./bin",
    "rootDir": "."
  },
  "include": ["./**/*.ts"],
  "exclude": ["node_modules"]
}
`;
}

function generateIndexTs(
  nodes: Node<ServiceNodeData>[],
  edges: Edge[]
): string {
  const serviceTypes = new Set(nodes.map((n) => n.data.serviceId));
  const imports: string[] = [];
  const instantiations: string[] = [];
  const exports: string[] = [];

  // Add imports
  imports.push(`import * as pulumi from "@pulumi/pulumi";`);
  serviceTypes.forEach((serviceId) => {
    const className = getComponentClassName(serviceId);
    imports.push(`import { ${className} } from "./components/${serviceId}";`);
  });

  // Add config
  instantiations.push(`
// Configuration
const config = new pulumi.Config();
const environment = config.get("environment") || "production";
`);

  // Add instantiations
  nodes.forEach((node) => {
    const resourceName = sanitizeName(node.data.serviceName);
    const className = getComponentClassName(node.data.serviceId);
    const propsString = generatePropsObject(node);

    instantiations.push(`// ${node.data.serviceName}
const ${resourceName} = new ${className}("${resourceName}", {
  environment,
${propsString}
});
`);

    exports.push(`export const ${resourceName}Id = ${resourceName}.id;`);
  });

  return `// Generated by Archyra Architecture Designer
// Pulumi TypeScript Configuration

${imports.join('\n')}

${instantiations.join('\n')}

// Exports
${exports.join('\n')}
`;
}

function getComponentClassName(serviceId: string): string {
  const classNames: Record<string, string> = {
    ec2: 'Ec2Instance',
    lambda: 'LambdaFunction',
    s3: 'S3Bucket',
    rds: 'RdsDatabase',
    dynamodb: 'DynamoDbTable',
    'api-gateway': 'ApiGateway',
    cloudfront: 'CloudFrontDistribution',
    sqs: 'SqsQueue',
    sns: 'SnsTopic',
    cognito: 'CognitoUserPool',
    vpc: 'Vpc',
    ecs: 'EcsCluster',
    elasticache: 'ElastiCacheCluster',
    iam: 'IamRole',
    route53: 'Route53Zone',
  };
  return classNames[serviceId] || toPascalCase(serviceId);
}

function generatePropsObject(node: Node<ServiceNodeData>): string {
  const props = node.data.properties;
  const lines: string[] = [];

  Object.entries(props).forEach(([key, value]) => {
    if (value !== '' && value !== undefined && value !== null) {
      if (typeof value === 'string') {
        lines.push(`  ${key}: "${value}",`);
      } else if (typeof value === 'boolean') {
        lines.push(`  ${key}: ${value},`);
      } else if (typeof value === 'number') {
        lines.push(`  ${key}: ${value},`);
      }
    }
  });

  return lines.join('\n');
}

function generateComponentFile(serviceId: string): string {
  switch (serviceId) {
    case 'ec2':
      return generateEc2Component();
    case 'lambda':
      return generateLambdaComponent();
    case 's3':
      return generateS3Component();
    case 'rds':
      return generateRdsComponent();
    case 'dynamodb':
      return generateDynamoDbComponent();
    case 'api-gateway':
      return generateApiGatewayComponent();
    case 'cloudfront':
      return generateCloudFrontComponent();
    case 'sqs':
      return generateSqsComponent();
    case 'sns':
      return generateSnsComponent();
    case 'cognito':
      return generateCognitoComponent();
    case 'vpc':
      return generateVpcComponent();
    case 'ecs':
      return generateEcsComponent();
    case 'elasticache':
      return generateElastiCacheComponent();
    case 'iam':
      return generateIamComponent();
    case 'route53':
      return generateRoute53Component();
    case 'vpc-environment':
      return generateVpcEnvironmentComponent();
    case 'public-subnet':
      return generatePublicSubnetComponent();
    case 'private-subnet':
      return generatePrivateSubnetComponent();
    case 'alb':
      return generateAlbComponent();
    case 'nlb':
      return generateNlbComponent();
    case 'nat-gateway':
      return generateNatGatewayComponent();
    default:
      return `// TODO: Add ${serviceId} component\n`;
  }
}

function generateEc2Component(): string {
  return `// EC2 Instance Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface Ec2InstanceArgs {
  environment: string;
  instanceName?: string;
  instanceType?: string;
  ami?: string;
  rootVolumeSize?: number;
  rootVolumeType?: string;
  publicIp?: boolean;
  keyPair?: string;
  monitoring?: boolean;
}

export class Ec2Instance extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly publicIp: pulumi.Output<string>;
  public readonly privateIp: pulumi.Output<string>;

  constructor(name: string, args: Ec2InstanceArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:Ec2Instance", name, {}, opts);

    const amiLookup = aws.ec2.getAmi({
      mostRecent: true,
      owners: ["amazon"],
      filters: [{
        name: "name",
        values: [
          args.ami === "amazon-linux-2023" ? "al2023-ami-*-x86_64" :
          args.ami === "amazon-linux-2" ? "amzn2-ami-hvm-*-x86_64-gp2" :
          args.ami === "ubuntu-24" ? "ubuntu/images/hvm-ssd/ubuntu-noble-24.04-amd64-server-*" :
          args.ami === "ubuntu-22" ? "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*" :
          "al2023-ami-*-x86_64"
        ],
      }],
    });

    const instance = new aws.ec2.Instance(\`\${name}-instance\`, {
      ami: amiLookup.then(ami => ami.id),
      instanceType: args.instanceType || "t3.micro",
      rootBlockDevice: {
        volumeSize: args.rootVolumeSize || 30,
        volumeType: args.rootVolumeType || "gp3",
        encrypted: true,
      },
      associatePublicIpAddress: args.publicIp ?? true,
      keyName: args.keyPair || undefined,
      monitoring: args.monitoring || false,
      tags: {
        Name: args.instanceName || name,
        Environment: args.environment,
      },
    }, { parent: this });

    this.id = instance.id;
    this.publicIp = instance.publicIp;
    this.privateIp = instance.privateIp;

    this.registerOutputs({
      id: this.id,
      publicIp: this.publicIp,
      privateIp: this.privateIp,
    });
  }
}
`;
}

function generateLambdaComponent(): string {
  return `// Lambda Function Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface LambdaFunctionArgs {
  environment: string;
  functionName?: string;
  runtime?: string;
  handler?: string;
  memory?: number;
  timeout?: number;
  architecture?: string;
  reservedConcurrency?: number;
  envVars?: string;
  enableTracing?: boolean;
}

export class LambdaFunction extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly arn: pulumi.Output<string>;
  public readonly invokeArn: pulumi.Output<string>;

  constructor(name: string, args: LambdaFunctionArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:LambdaFunction", name, {}, opts);

    const role = new aws.iam.Role(\`\${name}-role\`, {
      assumeRolePolicy: JSON.stringify({
        Version: "2012-10-17",
        Statement: [{
          Action: "sts:AssumeRole",
          Effect: "Allow",
          Principal: { Service: "lambda.amazonaws.com" },
        }],
      }),
    }, { parent: this });

    new aws.iam.RolePolicyAttachment(\`\${name}-policy\`, {
      role: role.name,
      policyArn: "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
    }, { parent: this });

    const envVariables: Record<string, string> = { ENVIRONMENT: args.environment };
    if (args.envVars) {
      args.envVars.split("\\n").forEach(line => {
        const [key, value] = line.split("=");
        if (key && value) envVariables[key.trim()] = value.trim();
      });
    }

    const lambdaFunction = new aws.lambda.Function(\`\${name}-function\`, {
      name: args.functionName || name,
      role: role.arn,
      handler: args.handler || "index.handler",
      runtime: args.runtime || "nodejs20.x",
      memorySize: args.memory || 256,
      timeout: args.timeout || 30,
      architectures: [args.architecture || "arm64"],
      reservedConcurrentExecutions: args.reservedConcurrency && args.reservedConcurrency >= 0
        ? args.reservedConcurrency : undefined,
      code: new pulumi.asset.AssetArchive({
        "index.js": new pulumi.asset.StringAsset(\`
          exports.handler = async (event) => {
            return { statusCode: 200, body: "Hello from Lambda!" };
          };
        \`),
      }),
      environment: { variables: envVariables },
      tracingConfig: {
        mode: args.enableTracing ? "Active" : "PassThrough",
      },
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    this.id = lambdaFunction.id;
    this.arn = lambdaFunction.arn;
    this.invokeArn = lambdaFunction.invokeArn;

    this.registerOutputs({
      id: this.id,
      arn: this.arn,
      invokeArn: this.invokeArn,
    });
  }
}
`;
}

function generateS3Component(): string {
  return `// S3 Bucket Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface S3BucketArgs {
  environment: string;
  bucketName: string;
  versioning?: boolean;
  encryption?: string;
  publicAccess?: boolean;
  staticHosting?: boolean;
  indexDocument?: string;
  errorDocument?: string;
  lifecycleEnabled?: boolean;
  transitionDays?: number;
  expirationDays?: number;
  enableCors?: boolean;
}

export class S3Bucket extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly arn: pulumi.Output<string>;
  public readonly bucketDomainName: pulumi.Output<string>;

  constructor(name: string, args: S3BucketArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:S3Bucket", name, {}, opts);

    const bucket = new aws.s3.Bucket(\`\${name}-bucket\`, {
      bucket: args.bucketName,
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    new aws.s3.BucketVersioningV2(\`\${name}-versioning\`, {
      bucket: bucket.id,
      versioningConfiguration: {
        status: args.versioning ? "Enabled" : "Suspended",
      },
    }, { parent: this });

    if (args.encryption && args.encryption !== "none") {
      new aws.s3.BucketServerSideEncryptionConfigurationV2(\`\${name}-encryption\`, {
        bucket: bucket.id,
        rules: [{
          applyServerSideEncryptionByDefault: {
            sseAlgorithm: args.encryption === "aws:kms" ? "aws:kms" : "AES256",
          },
        }],
      }, { parent: this });
    }

    new aws.s3.BucketPublicAccessBlock(\`\${name}-public-access\`, {
      bucket: bucket.id,
      blockPublicAcls: args.publicAccess ?? true,
      blockPublicPolicy: args.publicAccess ?? true,
      ignorePublicAcls: args.publicAccess ?? true,
      restrictPublicBuckets: args.publicAccess ?? true,
    }, { parent: this });

    if (args.staticHosting) {
      new aws.s3.BucketWebsiteConfigurationV2(\`\${name}-website\`, {
        bucket: bucket.id,
        indexDocument: { suffix: args.indexDocument || "index.html" },
        errorDocument: { key: args.errorDocument || "error.html" },
      }, { parent: this });
    }

    if (args.lifecycleEnabled) {
      new aws.s3.BucketLifecycleConfigurationV2(\`\${name}-lifecycle\`, {
        bucket: bucket.id,
        rules: [{
          id: "lifecycle-rule",
          status: "Enabled",
          transitions: [{
            days: args.transitionDays || 30,
            storageClass: "STANDARD_IA",
          }],
          expiration: args.expirationDays && args.expirationDays > 0
            ? { days: args.expirationDays } : undefined,
        }],
      }, { parent: this });
    }

    if (args.enableCors) {
      new aws.s3.BucketCorsConfigurationV2(\`\${name}-cors\`, {
        bucket: bucket.id,
        corsRules: [{
          allowedHeaders: ["*"],
          allowedMethods: ["GET", "HEAD", "PUT", "POST", "DELETE"],
          allowedOrigins: ["*"],
          maxAgeSeconds: 3000,
        }],
      }, { parent: this });
    }

    this.id = bucket.id;
    this.arn = bucket.arn;
    this.bucketDomainName = bucket.bucketRegionalDomainName;

    this.registerOutputs({
      id: this.id,
      arn: this.arn,
      bucketDomainName: this.bucketDomainName,
    });
  }
}
`;
}

function generateRdsComponent(): string {
  return `// RDS Database Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface RdsDatabaseArgs {
  environment: string;
  identifier: string;
  engine?: string;
  instanceClass?: string;
  allocatedStorage?: number;
  maxAllocatedStorage?: number;
  storageType?: string;
  dbName?: string;
  masterUsername?: string;
  port?: number;
  multiAz?: boolean;
  publiclyAccessible?: boolean;
  backupRetention?: number;
  deletionProtection?: boolean;
  performanceInsights?: boolean;
}

export class RdsDatabase extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly endpoint: pulumi.Output<string>;
  public readonly port: pulumi.Output<number>;

  constructor(name: string, args: RdsDatabaseArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:RdsDatabase", name, {}, opts);

    const config = new pulumi.Config();
    const password = config.requireSecret("dbPassword");

    const instance = new aws.rds.Instance(\`\${name}-db\`, {
      identifier: args.identifier,
      engine: args.engine || "postgres",
      engineVersion: args.engine === "postgres" ? "16" : args.engine === "mysql" ? "8.0" : undefined,
      instanceClass: args.instanceClass || "db.t3.micro",
      allocatedStorage: args.allocatedStorage || 20,
      maxAllocatedStorage: args.maxAllocatedStorage || 100,
      storageType: args.storageType || "gp3",
      storageEncrypted: true,
      dbName: args.dbName || "mydb",
      username: args.masterUsername || "admin",
      password: password,
      port: args.port || 5432,
      multiAz: args.multiAz || false,
      publiclyAccessible: args.publiclyAccessible || false,
      backupRetentionPeriod: args.backupRetention || 7,
      deletionProtection: args.deletionProtection ?? true,
      skipFinalSnapshot: !(args.deletionProtection ?? true),
      performanceInsightsEnabled: args.performanceInsights || false,
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    this.id = instance.id;
    this.endpoint = instance.endpoint;
    this.port = instance.port;

    this.registerOutputs({
      id: this.id,
      endpoint: this.endpoint,
      port: this.port,
    });
  }
}
`;
}

function generateDynamoDbComponent(): string {
  return `// DynamoDB Table Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface DynamoDbTableArgs {
  environment: string;
  tableName: string;
  billingMode?: string;
  hashKey?: string;
  hashKeyType?: string;
  rangeKey?: string;
  rangeKeyType?: string;
  readCapacity?: number;
  writeCapacity?: number;
  enableStreams?: boolean;
  streamViewType?: string;
  ttlAttribute?: string;
  pointInTimeRecovery?: boolean;
}

export class DynamoDbTable extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly arn: pulumi.Output<string>;

  constructor(name: string, args: DynamoDbTableArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:DynamoDbTable", name, {}, opts);

    const attributes: aws.dynamodb.TableAttributeArgs[] = [
      { name: args.hashKey || "id", type: args.hashKeyType || "S" },
    ];

    if (args.rangeKey) {
      attributes.push({ name: args.rangeKey, type: args.rangeKeyType || "S" });
    }

    const table = new aws.dynamodb.Table(\`\${name}-table\`, {
      name: args.tableName,
      billingMode: args.billingMode || "PAY_PER_REQUEST",
      hashKey: args.hashKey || "id",
      rangeKey: args.rangeKey || undefined,
      attributes: attributes,
      readCapacity: args.billingMode === "PROVISIONED" ? (args.readCapacity || 5) : undefined,
      writeCapacity: args.billingMode === "PROVISIONED" ? (args.writeCapacity || 5) : undefined,
      streamEnabled: args.enableStreams || false,
      streamViewType: args.enableStreams ? (args.streamViewType || "NEW_AND_OLD_IMAGES") : undefined,
      ttl: args.ttlAttribute ? { attributeName: args.ttlAttribute, enabled: true } : undefined,
      pointInTimeRecovery: { enabled: args.pointInTimeRecovery || false },
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    this.id = table.id;
    this.arn = table.arn;

    this.registerOutputs({
      id: this.id,
      arn: this.arn,
    });
  }
}
`;
}

function generateApiGatewayComponent(): string {
  return `// API Gateway Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface ApiGatewayArgs {
  environment: string;
  apiName: string;
  apiType?: string;
  stageName?: string;
  corsEnabled?: boolean;
  corsOrigins?: string;
  throttlingBurstLimit?: number;
  throttlingRateLimit?: number;
  enableAccessLogs?: boolean;
  enableXRay?: boolean;
}

export class ApiGateway extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly endpoint: pulumi.Output<string>;

  constructor(name: string, args: ApiGatewayArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:ApiGateway", name, {}, opts);

    const api = new aws.apigatewayv2.Api(\`\${name}-api\`, {
      name: args.apiName,
      protocolType: args.apiType || "HTTP",
      corsConfiguration: args.corsEnabled ? {
        allowOrigins: (args.corsOrigins || "*").split(","),
        allowMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
        allowHeaders: ["*"],
      } : undefined,
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    let logGroup: aws.cloudwatch.LogGroup | undefined;
    if (args.enableAccessLogs) {
      logGroup = new aws.cloudwatch.LogGroup(\`\${name}-logs\`, {
        name: \`/aws/apigateway/\${name}\`,
      }, { parent: this });
    }

    const stage = new aws.apigatewayv2.Stage(\`\${name}-stage\`, {
      apiId: api.id,
      name: args.stageName || "prod",
      autoDeploy: true,
      defaultRouteSettings: {
        throttlingBurstLimit: args.throttlingBurstLimit || 5000,
        throttlingRateLimit: args.throttlingRateLimit || 10000,
      },
      accessLogSettings: logGroup ? {
        destinationArn: logGroup.arn,
        format: JSON.stringify({
          requestId: "$context.requestId",
          ip: "$context.identity.sourceIp",
          requestTime: "$context.requestTime",
          httpMethod: "$context.httpMethod",
          routeKey: "$context.routeKey",
          status: "$context.status",
          responseLength: "$context.responseLength",
        }),
      } : undefined,
    }, { parent: this });

    this.id = api.id;
    this.endpoint = stage.invokeUrl;

    this.registerOutputs({
      id: this.id,
      endpoint: this.endpoint,
    });
  }
}
`;
}

function generateCloudFrontComponent(): string {
  return `// CloudFront Distribution Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface CloudFrontDistributionArgs {
  environment: string;
  comment?: string;
  priceClass?: string;
  defaultRootObject?: string;
  defaultTtl?: number;
  maxTtl?: number;
  minTtl?: number;
  viewerProtocol?: string;
  enableCompression?: boolean;
  enableWaf?: boolean;
  enableLogging?: boolean;
  originDomainName?: string;
}

export class CloudFrontDistribution extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly domainName: pulumi.Output<string>;

  constructor(name: string, args: CloudFrontDistributionArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:CloudFrontDistribution", name, {}, opts);

    const distribution = new aws.cloudfront.Distribution(\`\${name}-distribution\`, {
      enabled: true,
      comment: args.comment || "My Distribution",
      defaultRootObject: args.defaultRootObject || "index.html",
      priceClass: args.priceClass || "PriceClass_100",
      origins: [{
        domainName: args.originDomainName || "example.com",
        originId: "primary",
        customOriginConfig: {
          httpPort: 80,
          httpsPort: 443,
          originProtocolPolicy: "https-only",
          originSslProtocols: ["TLSv1.2"],
        },
      }],
      defaultCacheBehavior: {
        allowedMethods: ["GET", "HEAD", "OPTIONS", "PUT", "POST", "PATCH", "DELETE"],
        cachedMethods: ["GET", "HEAD"],
        targetOriginId: "primary",
        viewerProtocolPolicy: args.viewerProtocol || "redirect-to-https",
        compress: args.enableCompression ?? true,
        minTtl: args.minTtl || 0,
        defaultTtl: args.defaultTtl || 86400,
        maxTtl: args.maxTtl || 31536000,
        forwardedValues: {
          queryString: true,
          cookies: { forward: "none" },
        },
      },
      restrictions: {
        geoRestriction: { restrictionType: "none" },
      },
      viewerCertificate: {
        cloudfrontDefaultCertificate: true,
      },
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    this.id = distribution.id;
    this.domainName = distribution.domainName;

    this.registerOutputs({
      id: this.id,
      domainName: this.domainName,
    });
  }
}
`;
}

function generateSqsComponent(): string {
  return `// SQS Queue Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface SqsQueueArgs {
  environment: string;
  queueName: string;
  fifoQueue?: boolean;
  contentBasedDedup?: boolean;
  visibilityTimeout?: number;
  messageRetention?: number;
  maxMessageSize?: number;
  delaySeconds?: number;
  receiveWaitTime?: number;
  enableDlq?: boolean;
  maxReceiveCount?: number;
  enableEncryption?: boolean;
}

export class SqsQueue extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly arn: pulumi.Output<string>;
  public readonly url: pulumi.Output<string>;

  constructor(name: string, args: SqsQueueArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:SqsQueue", name, {}, opts);

    const queueName = args.fifoQueue ? \`\${args.queueName}.fifo\` : args.queueName;

    let dlq: aws.sqs.Queue | undefined;
    if (args.enableDlq) {
      const dlqName = args.fifoQueue ? \`\${args.queueName}-dlq.fifo\` : \`\${args.queueName}-dlq\`;
      dlq = new aws.sqs.Queue(\`\${name}-dlq\`, {
        name: dlqName,
        fifoQueue: args.fifoQueue || false,
        tags: {
          Name: \`\${name}-dlq\`,
          Environment: args.environment,
        },
      }, { parent: this });
    }

    const queue = new aws.sqs.Queue(\`\${name}-queue\`, {
      name: queueName,
      fifoQueue: args.fifoQueue || false,
      contentBasedDeduplication: args.fifoQueue ? (args.contentBasedDedup || false) : undefined,
      visibilityTimeoutSeconds: args.visibilityTimeout || 30,
      messageRetentionSeconds: args.messageRetention || 345600,
      maxMessageSize: args.maxMessageSize || 262144,
      delaySeconds: args.delaySeconds || 0,
      receiveWaitTimeSeconds: args.receiveWaitTime || 0,
      sqsManagedSseEnabled: args.enableEncryption ?? true,
      redrivePolicy: dlq ? JSON.stringify({
        deadLetterTargetArn: dlq.arn,
        maxReceiveCount: args.maxReceiveCount || 3,
      }) : undefined,
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    this.id = queue.id;
    this.arn = queue.arn;
    this.url = queue.url;

    this.registerOutputs({
      id: this.id,
      arn: this.arn,
      url: this.url,
    });
  }
}
`;
}

function generateSnsComponent(): string {
  return `// SNS Topic Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface SnsTopicArgs {
  environment: string;
  topicName: string;
  displayName?: string;
  fifoTopic?: boolean;
  contentBasedDedup?: boolean;
  kmsMasterKeyId?: string;
  deliveryPolicy?: number;
}

export class SnsTopic extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly arn: pulumi.Output<string>;

  constructor(name: string, args: SnsTopicArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:SnsTopic", name, {}, opts);

    const topicName = args.fifoTopic ? \`\${args.topicName}.fifo\` : args.topicName;

    const topic = new aws.sns.Topic(\`\${name}-topic\`, {
      name: topicName,
      displayName: args.displayName || undefined,
      fifoTopic: args.fifoTopic || false,
      contentBasedDeduplication: args.fifoTopic ? (args.contentBasedDedup || false) : undefined,
      kmsMasterKeyId: args.kmsMasterKeyId || undefined,
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    this.id = topic.id;
    this.arn = topic.arn;

    this.registerOutputs({
      id: this.id,
      arn: this.arn,
    });
  }
}
`;
}

function generateCognitoComponent(): string {
  return `// Cognito User Pool Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface CognitoUserPoolArgs {
  environment: string;
  poolName: string;
  mfaConfiguration?: string;
  usernameAttributes?: string;
  autoVerifiedAttributes?: string;
  passwordMinLength?: number;
  passwordRequireUppercase?: boolean;
  passwordRequireLowercase?: boolean;
  passwordRequireNumbers?: boolean;
  passwordRequireSymbols?: boolean;
  allowAdminUserCreation?: boolean;
  emailVerificationMessage?: string;
}

export class CognitoUserPool extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly arn: pulumi.Output<string>;
  public readonly clientId: pulumi.Output<string>;

  constructor(name: string, args: CognitoUserPoolArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:CognitoUserPool", name, {}, opts);

    const userPool = new aws.cognito.UserPool(\`\${name}-pool\`, {
      name: args.poolName,
      mfaConfiguration: args.mfaConfiguration || "OPTIONAL",
      usernameAttributes: [args.usernameAttributes || "email"],
      autoVerifiedAttributes: [args.autoVerifiedAttributes || "email"],
      passwordPolicy: {
        minimumLength: args.passwordMinLength || 8,
        requireUppercase: args.passwordRequireUppercase ?? true,
        requireLowercase: args.passwordRequireLowercase ?? true,
        requireNumbers: args.passwordRequireNumbers ?? true,
        requireSymbols: args.passwordRequireSymbols ?? true,
      },
      adminCreateUserConfig: {
        allowAdminCreateUserOnly: args.allowAdminUserCreation || false,
      },
      verificationMessageTemplate: {
        defaultEmailOption: "CONFIRM_WITH_CODE",
        emailMessage: args.emailVerificationMessage || "Your verification code is {####}",
      },
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    const client = new aws.cognito.UserPoolClient(\`\${name}-client\`, {
      name: \`\${name}_client\`,
      userPoolId: userPool.id,
      generateSecret: false,
      explicitAuthFlows: [
        "ALLOW_USER_PASSWORD_AUTH",
        "ALLOW_REFRESH_TOKEN_AUTH",
        "ALLOW_USER_SRP_AUTH",
      ],
    }, { parent: this });

    this.id = userPool.id;
    this.arn = userPool.arn;
    this.clientId = client.id;

    this.registerOutputs({
      id: this.id,
      arn: this.arn,
      clientId: this.clientId,
    });
  }
}
`;
}

function generateVpcComponent(): string {
  return `// VPC Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface VpcArgs {
  environment: string;
  vpcName: string;
  cidrBlock?: string;
  enableDnsHostnames?: boolean;
  enableDnsSupport?: boolean;
  publicSubnets?: number;
  privateSubnets?: number;
  enableNatGateway?: boolean;
  singleNatGateway?: boolean;
  enableVpnGateway?: boolean;
}

export class Vpc extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly publicSubnetIds: pulumi.Output<string>[];
  public readonly privateSubnetIds: pulumi.Output<string>[];

  constructor(name: string, args: VpcArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:Vpc", name, {}, opts);

    const azs = aws.getAvailabilityZones({ state: "available" });

    const vpc = new aws.ec2.Vpc(\`\${name}-vpc\`, {
      cidrBlock: args.cidrBlock || "10.0.0.0/16",
      enableDnsHostnames: args.enableDnsHostnames ?? true,
      enableDnsSupport: args.enableDnsSupport ?? true,
      tags: {
        Name: args.vpcName || name,
        Environment: args.environment,
      },
    }, { parent: this });

    const igw = new aws.ec2.InternetGateway(\`\${name}-igw\`, {
      vpcId: vpc.id,
      tags: { Name: \`\${name}-igw\` },
    }, { parent: this });

    const publicSubnets: aws.ec2.Subnet[] = [];
    const privateSubnets: aws.ec2.Subnet[] = [];

    const publicCount = args.publicSubnets || 2;
    const privateCount = args.privateSubnets || 2;

    for (let i = 0; i < publicCount; i++) {
      const subnet = new aws.ec2.Subnet(\`\${name}-public-\${i}\`, {
        vpcId: vpc.id,
        cidrBlock: \`10.0.\${i}.0/24\`,
        availabilityZone: azs.then(az => az.names[i % az.names.length]),
        mapPublicIpOnLaunch: true,
        tags: {
          Name: \`\${name}-public-\${i + 1}\`,
          Type: "public",
        },
      }, { parent: this });
      publicSubnets.push(subnet);
    }

    for (let i = 0; i < privateCount; i++) {
      const subnet = new aws.ec2.Subnet(\`\${name}-private-\${i}\`, {
        vpcId: vpc.id,
        cidrBlock: \`10.0.\${i + publicCount}.0/24\`,
        availabilityZone: azs.then(az => az.names[i % az.names.length]),
        tags: {
          Name: \`\${name}-private-\${i + 1}\`,
          Type: "private",
        },
      }, { parent: this });
      privateSubnets.push(subnet);
    }

    if (args.enableNatGateway) {
      const natCount = args.singleNatGateway ? 1 : publicCount;
      for (let i = 0; i < natCount; i++) {
        const eip = new aws.ec2.Eip(\`\${name}-nat-eip-\${i}\`, {
          domain: "vpc",
          tags: { Name: \`\${name}-nat-eip-\${i + 1}\` },
        }, { parent: this });

        new aws.ec2.NatGateway(\`\${name}-nat-\${i}\`, {
          allocationId: eip.id,
          subnetId: publicSubnets[i].id,
          tags: { Name: \`\${name}-nat-\${i + 1}\` },
        }, { parent: this });
      }
    }

    this.id = vpc.id;
    this.publicSubnetIds = publicSubnets.map(s => s.id);
    this.privateSubnetIds = privateSubnets.map(s => s.id);

    this.registerOutputs({
      id: this.id,
      publicSubnetIds: this.publicSubnetIds,
      privateSubnetIds: this.privateSubnetIds,
    });
  }
}
`;
}

function generateEcsComponent(): string {
  return `// ECS Cluster Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface EcsClusterArgs {
  environment: string;
  clusterName: string;
  serviceName: string;
  launchType?: string;
  cpu?: string;
  memory?: string;
  desiredCount?: number;
  containerPort?: number;
  healthCheckPath?: string;
  enableAutoScaling?: boolean;
  minCapacity?: number;
  maxCapacity?: number;
  vpcId?: string;
  subnetIds?: string[];
}

export class EcsCluster extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly serviceName: pulumi.Output<string>;

  constructor(name: string, args: EcsClusterArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:EcsCluster", name, {}, opts);

    const cluster = new aws.ecs.Cluster(\`\${name}-cluster\`, {
      name: args.clusterName,
      settings: [{ name: "containerInsights", value: "enabled" }],
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    const executionRole = new aws.iam.Role(\`\${name}-execution-role\`, {
      assumeRolePolicy: JSON.stringify({
        Version: "2012-10-17",
        Statement: [{
          Action: "sts:AssumeRole",
          Effect: "Allow",
          Principal: { Service: "ecs-tasks.amazonaws.com" },
        }],
      }),
    }, { parent: this });

    new aws.iam.RolePolicyAttachment(\`\${name}-execution-policy\`, {
      role: executionRole.name,
      policyArn: "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy",
    }, { parent: this });

    const logGroup = new aws.cloudwatch.LogGroup(\`\${name}-logs\`, {
      name: \`/ecs/\${name}\`,
      retentionInDays: 30,
    }, { parent: this });

    const launchType = args.launchType === "FARGATE_SPOT" ? "FARGATE" : (args.launchType || "FARGATE");

    const taskDefinition = new aws.ecs.TaskDefinition(\`\${name}-task\`, {
      family: args.serviceName,
      networkMode: "awsvpc",
      requiresCompatibilities: [launchType],
      cpu: args.cpu || "512",
      memory: args.memory || "1024",
      executionRoleArn: executionRole.arn,
      containerDefinitions: pulumi.all([logGroup.name]).apply(([logGroupName]) => JSON.stringify([{
        name: args.serviceName,
        image: "nginx:latest",
        essential: true,
        portMappings: [{
          containerPort: args.containerPort || 80,
          hostPort: args.containerPort || 80,
          protocol: "tcp",
        }],
        healthCheck: {
          command: ["CMD-SHELL", \`curl -f http://localhost\${args.healthCheckPath || "/health"} || exit 1\`],
          interval: 30,
          timeout: 5,
          retries: 3,
          startPeriod: 60,
        },
        logConfiguration: {
          logDriver: "awslogs",
          options: {
            "awslogs-group": logGroupName,
            "awslogs-region": aws.getRegion().then(r => r.name),
            "awslogs-stream-prefix": "ecs",
          },
        },
      }])),
      tags: { Name: name },
    }, { parent: this });

    const service = new aws.ecs.Service(\`\${name}-service\`, {
      name: args.serviceName,
      cluster: cluster.id,
      taskDefinition: taskDefinition.arn,
      desiredCount: args.desiredCount || 2,
      launchType: args.launchType === "FARGATE_SPOT" ? undefined : launchType,
      capacityProviderStrategies: args.launchType === "FARGATE_SPOT" ? [{
        capacityProvider: "FARGATE_SPOT",
        weight: 1,
      }] : undefined,
      networkConfiguration: {
        subnets: args.subnetIds || [],
        assignPublicIp: true,
      },
      tags: { Name: name },
    }, { parent: this });

    if (args.enableAutoScaling) {
      const target = new aws.appautoscaling.Target(\`\${name}-scaling-target\`, {
        maxCapacity: args.maxCapacity || 10,
        minCapacity: args.minCapacity || 1,
        resourceId: pulumi.interpolate\`service/\${cluster.name}/\${service.name}\`,
        scalableDimension: "ecs:service:DesiredCount",
        serviceNamespace: "ecs",
      }, { parent: this });
    }

    this.id = cluster.id;
    this.serviceName = service.name;

    this.registerOutputs({
      id: this.id,
      serviceName: this.serviceName,
    });
  }
}
`;
}

function generateElastiCacheComponent(): string {
  return `// ElastiCache Cluster Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface ElastiCacheClusterArgs {
  environment: string;
  clusterId: string;
  engine?: string;
  nodeType?: string;
  numCacheNodes?: number;
  port?: number;
  parameterGroupFamily?: string;
  snapshotRetention?: number;
  transitEncryption?: boolean;
  atRestEncryption?: boolean;
}

export class ElastiCacheCluster extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly cacheNodes: pulumi.Output<aws.elasticache.outputs.ClusterCacheNode[]>;

  constructor(name: string, args: ElastiCacheClusterArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:ElastiCacheCluster", name, {}, opts);

    const engine = args.engine || "redis";
    const parameterGroup = args.parameterGroupFamily === "redis7" ? "default.redis7" :
                          args.parameterGroupFamily === "redis6.x" ? "default.redis6.x" :
                          "default.memcached1.6";

    const cluster = new aws.elasticache.Cluster(\`\${name}-cache\`, {
      clusterId: args.clusterId,
      engine: engine,
      nodeType: args.nodeType || "cache.t3.micro",
      numCacheNodes: args.numCacheNodes || 1,
      port: args.port || (engine === "memcached" ? 11211 : 6379),
      parameterGroupName: parameterGroup,
      snapshotRetentionLimit: args.snapshotRetention || 0,
      transitEncryptionEnabled: args.transitEncryption ?? true,
      atRestEncryptionEnabled: args.atRestEncryption ?? true,
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    this.id = cluster.id;
    this.cacheNodes = cluster.cacheNodes;

    this.registerOutputs({
      id: this.id,
      cacheNodes: this.cacheNodes,
    });
  }
}
`;
}

function generateIamComponent(): string {
  return `// IAM Role Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface IamRoleArgs {
  environment: string;
  roleName: string;
  description?: string;
  assumeRoleService?: string;
  managedPolicies?: string;
  maxSessionDuration?: number;
}

export class IamRole extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly arn: pulumi.Output<string>;

  constructor(name: string, args: IamRoleArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:IamRole", name, {}, opts);

    const role = new aws.iam.Role(\`\${name}-role\`, {
      name: args.roleName,
      description: args.description || undefined,
      assumeRolePolicy: JSON.stringify({
        Version: "2012-10-17",
        Statement: [{
          Action: "sts:AssumeRole",
          Effect: "Allow",
          Principal: { Service: args.assumeRoleService || "lambda.amazonaws.com" },
        }],
      }),
      maxSessionDuration: args.maxSessionDuration || 3600,
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    if (args.managedPolicies) {
      const policies = args.managedPolicies.split("\\n").filter(p => p.trim());
      policies.forEach((policyArn, i) => {
        new aws.iam.RolePolicyAttachment(\`\${name}-policy-\${i}\`, {
          role: role.name,
          policyArn: policyArn.trim(),
        }, { parent: this });
      });
    }

    this.id = role.id;
    this.arn = role.arn;

    this.registerOutputs({
      id: this.id,
      arn: this.arn,
    });
  }
}
`;
}

function generateRoute53Component(): string {
  return `// Route 53 Zone Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface Route53ZoneArgs {
  environment: string;
  domainName: string;
  zoneType?: string;
  comment?: string;
  vpcId?: string;
}

export class Route53Zone extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly nameServers: pulumi.Output<string[]>;

  constructor(name: string, args: Route53ZoneArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:Route53Zone", name, {}, opts);

    const zone = new aws.route53.Zone(\`\${name}-zone\`, {
      name: args.domainName,
      comment: args.comment || undefined,
      vpcs: args.zoneType === "private" && args.vpcId ? [{ vpcId: args.vpcId }] : undefined,
      tags: {
        Name: name,
        Environment: args.environment,
      },
    }, { parent: this });

    this.id = zone.id;
    this.nameServers = zone.nameServers;

    this.registerOutputs({
      id: this.id,
      nameServers: this.nameServers,
    });
  }
}
`;
}

// VPC Environment Component
function generateVpcEnvironmentComponent(): string {
  return `// VPC Environment Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface VpcEnvironmentArgs {
  environment: string;
  vpcName?: string;
  cidrBlock?: string;
  enableDnsHostnames?: boolean;
  enableDnsSupport?: boolean;
}

export class VpcEnvironment extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly cidrBlock: pulumi.Output<string>;
  public readonly internetGatewayId: pulumi.Output<string>;
  public readonly publicRouteTableId: pulumi.Output<string>;

  constructor(name: string, args: VpcEnvironmentArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:VpcEnvironment", name, {}, opts);

    const vpc = new aws.ec2.Vpc(\`\${name}-vpc\`, {
      cidrBlock: args.cidrBlock || "10.0.0.0/16",
      enableDnsHostnames: args.enableDnsHostnames ?? true,
      enableDnsSupport: args.enableDnsSupport ?? true,
      tags: {
        Name: args.vpcName || name,
        Environment: args.environment,
      },
    }, { parent: this });

    const igw = new aws.ec2.InternetGateway(\`\${name}-igw\`, {
      vpcId: vpc.id,
      tags: {
        Name: \`\${name}-igw\`,
        Environment: args.environment,
      },
    }, { parent: this });

    const publicRouteTable = new aws.ec2.RouteTable(\`\${name}-public-rt\`, {
      vpcId: vpc.id,
      routes: [{
        cidrBlock: "0.0.0.0/0",
        gatewayId: igw.id,
      }],
      tags: {
        Name: \`\${name}-public-rt\`,
        Environment: args.environment,
        Type: "public",
      },
    }, { parent: this });

    this.id = vpc.id;
    this.cidrBlock = vpc.cidrBlock;
    this.internetGatewayId = igw.id;
    this.publicRouteTableId = publicRouteTable.id;

    this.registerOutputs({
      id: this.id,
      cidrBlock: this.cidrBlock,
      internetGatewayId: this.internetGatewayId,
      publicRouteTableId: this.publicRouteTableId,
    });
  }
}
`;
}

// Public Subnet Component
function generatePublicSubnetComponent(): string {
  return `// Public Subnet Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface PublicSubnetArgs {
  environment: string;
  subnetName?: string;
  cidrBlock?: string;
  availabilityZone?: string;
  vpcId: pulumi.Input<string>;
  publicRouteTableId: pulumi.Input<string>;
}

export class PublicSubnet extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly cidrBlock: pulumi.Output<string>;
  public readonly availabilityZone: pulumi.Output<string>;

  constructor(name: string, args: PublicSubnetArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:PublicSubnet", name, {}, opts);

    const subnet = new aws.ec2.Subnet(\`\${name}-subnet\`, {
      vpcId: args.vpcId,
      cidrBlock: args.cidrBlock || "10.0.1.0/24",
      availabilityZone: args.availabilityZone || undefined,
      mapPublicIpOnLaunch: true,
      tags: {
        Name: args.subnetName || name,
        Environment: args.environment,
        Type: "public",
      },
    }, { parent: this });

    new aws.ec2.RouteTableAssociation(\`\${name}-rta\`, {
      subnetId: subnet.id,
      routeTableId: args.publicRouteTableId,
    }, { parent: this });

    this.id = subnet.id;
    this.cidrBlock = subnet.cidrBlock;
    this.availabilityZone = subnet.availabilityZone;

    this.registerOutputs({
      id: this.id,
      cidrBlock: this.cidrBlock,
      availabilityZone: this.availabilityZone,
    });
  }
}
`;
}

// Private Subnet Component
function generatePrivateSubnetComponent(): string {
  return `// Private Subnet Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface PrivateSubnetArgs {
  environment: string;
  subnetName?: string;
  cidrBlock?: string;
  availabilityZone?: string;
  vpcId: pulumi.Input<string>;
  natGatewayId?: pulumi.Input<string>;
}

export class PrivateSubnet extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly cidrBlock: pulumi.Output<string>;
  public readonly availabilityZone: pulumi.Output<string>;
  public readonly routeTableId: pulumi.Output<string>;

  constructor(name: string, args: PrivateSubnetArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:PrivateSubnet", name, {}, opts);

    const subnet = new aws.ec2.Subnet(\`\${name}-subnet\`, {
      vpcId: args.vpcId,
      cidrBlock: args.cidrBlock || "10.0.10.0/24",
      availabilityZone: args.availabilityZone || undefined,
      mapPublicIpOnLaunch: false,
      tags: {
        Name: args.subnetName || name,
        Environment: args.environment,
        Type: "private",
      },
    }, { parent: this });

    const routes: aws.types.input.ec2.RouteTableRoute[] = [];
    if (args.natGatewayId) {
      routes.push({
        cidrBlock: "0.0.0.0/0",
        natGatewayId: args.natGatewayId,
      });
    }

    const routeTable = new aws.ec2.RouteTable(\`\${name}-rt\`, {
      vpcId: args.vpcId,
      routes: routes,
      tags: {
        Name: \`\${name}-rt\`,
        Environment: args.environment,
        Type: "private",
      },
    }, { parent: this });

    new aws.ec2.RouteTableAssociation(\`\${name}-rta\`, {
      subnetId: subnet.id,
      routeTableId: routeTable.id,
    }, { parent: this });

    this.id = subnet.id;
    this.cidrBlock = subnet.cidrBlock;
    this.availabilityZone = subnet.availabilityZone;
    this.routeTableId = routeTable.id;

    this.registerOutputs({
      id: this.id,
      cidrBlock: this.cidrBlock,
      availabilityZone: this.availabilityZone,
      routeTableId: this.routeTableId,
    });
  }
}
`;
}

// Application Load Balancer Component
function generateAlbComponent(): string {
  return `// Application Load Balancer Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface AlbArgs {
  environment: string;
  albName?: string;
  internal?: boolean;
  idleTimeout?: number;
  enableHttp2?: boolean;
  enableDeletionProtection?: boolean;
  listenerPort?: number;
  targetPort?: number;
  healthCheckPath?: string;
  vpcId: pulumi.Input<string>;
  subnetIds: pulumi.Input<string>[];
}

export class Alb extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly arn: pulumi.Output<string>;
  public readonly dnsName: pulumi.Output<string>;
  public readonly securityGroupId: pulumi.Output<string>;
  public readonly targetGroupArn: pulumi.Output<string>;

  constructor(name: string, args: AlbArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:Alb", name, {}, opts);

    const sg = new aws.ec2.SecurityGroup(\`\${name}-sg\`, {
      name: \`\${args.albName || name}-sg\`,
      description: "Security group for Application Load Balancer",
      vpcId: args.vpcId,
      ingress: [
        { fromPort: 80, toPort: 80, protocol: "tcp", cidrBlocks: ["0.0.0.0/0"], description: "HTTP" },
        { fromPort: 443, toPort: 443, protocol: "tcp", cidrBlocks: ["0.0.0.0/0"], description: "HTTPS" },
      ],
      egress: [
        { fromPort: 0, toPort: 0, protocol: "-1", cidrBlocks: ["0.0.0.0/0"], description: "All outbound" },
      ],
      tags: {
        Name: \`\${name}-sg\`,
        Environment: args.environment,
      },
    }, { parent: this });

    const alb = new aws.lb.LoadBalancer(\`\${name}-alb\`, {
      name: args.albName || name,
      internal: args.internal ?? false,
      loadBalancerType: "application",
      securityGroups: [sg.id],
      subnets: args.subnetIds,
      enableDeletionProtection: args.enableDeletionProtection ?? false,
      idleTimeout: args.idleTimeout || 60,
      enableHttp2: args.enableHttp2 ?? true,
      tags: {
        Name: args.albName || name,
        Environment: args.environment,
      },
    }, { parent: this });

    const targetGroup = new aws.lb.TargetGroup(\`\${name}-tg\`, {
      name: \`\${(args.albName || name).substring(0, 28)}-tg\`,
      port: args.targetPort || 80,
      protocol: "HTTP",
      vpcId: args.vpcId,
      targetType: "ip",
      healthCheck: {
        enabled: true,
        healthyThreshold: 2,
        interval: 30,
        matcher: "200-299",
        path: args.healthCheckPath || "/",
        port: "traffic-port",
        protocol: "HTTP",
        timeout: 5,
        unhealthyThreshold: 2,
      },
      tags: {
        Name: \`\${name}-tg\`,
        Environment: args.environment,
      },
    }, { parent: this });

    new aws.lb.Listener(\`\${name}-listener\`, {
      loadBalancerArn: alb.arn,
      port: args.listenerPort || 80,
      protocol: "HTTP",
      defaultActions: [{
        type: "forward",
        targetGroupArn: targetGroup.arn,
      }],
    }, { parent: this });

    this.id = alb.id;
    this.arn = alb.arn;
    this.dnsName = alb.dnsName;
    this.securityGroupId = sg.id;
    this.targetGroupArn = targetGroup.arn;

    this.registerOutputs({
      id: this.id,
      arn: this.arn,
      dnsName: this.dnsName,
      securityGroupId: this.securityGroupId,
      targetGroupArn: this.targetGroupArn,
    });
  }
}
`;
}

// Network Load Balancer Component
function generateNlbComponent(): string {
  return `// Network Load Balancer Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface NlbArgs {
  environment: string;
  nlbName?: string;
  internal?: boolean;
  enableCrossZone?: boolean;
  listenerPort?: number;
  targetPort?: number;
  vpcId: pulumi.Input<string>;
  subnetIds: pulumi.Input<string>[];
}

export class Nlb extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly arn: pulumi.Output<string>;
  public readonly dnsName: pulumi.Output<string>;
  public readonly targetGroupArn: pulumi.Output<string>;

  constructor(name: string, args: NlbArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:Nlb", name, {}, opts);

    const nlb = new aws.lb.LoadBalancer(\`\${name}-nlb\`, {
      name: args.nlbName || name,
      internal: args.internal ?? false,
      loadBalancerType: "network",
      subnets: args.subnetIds,
      enableCrossZoneLoadBalancing: args.enableCrossZone ?? true,
      tags: {
        Name: args.nlbName || name,
        Environment: args.environment,
      },
    }, { parent: this });

    const targetGroup = new aws.lb.TargetGroup(\`\${name}-tg\`, {
      name: \`\${(args.nlbName || name).substring(0, 28)}-tg\`,
      port: args.targetPort || 80,
      protocol: "TCP",
      vpcId: args.vpcId,
      targetType: "ip",
      healthCheck: {
        enabled: true,
        healthyThreshold: 2,
        interval: 30,
        port: "traffic-port",
        protocol: "TCP",
        unhealthyThreshold: 2,
      },
      tags: {
        Name: \`\${name}-tg\`,
        Environment: args.environment,
      },
    }, { parent: this });

    new aws.lb.Listener(\`\${name}-listener\`, {
      loadBalancerArn: nlb.arn,
      port: args.listenerPort || 80,
      protocol: "TCP",
      defaultActions: [{
        type: "forward",
        targetGroupArn: targetGroup.arn,
      }],
    }, { parent: this });

    this.id = nlb.id;
    this.arn = nlb.arn;
    this.dnsName = nlb.dnsName;
    this.targetGroupArn = targetGroup.arn;

    this.registerOutputs({
      id: this.id,
      arn: this.arn,
      dnsName: this.dnsName,
      targetGroupArn: this.targetGroupArn,
    });
  }
}
`;
}

// NAT Gateway Component
function generateNatGatewayComponent(): string {
  return `// NAT Gateway Component
import * as pulumi from "@pulumi/pulumi";
import * as aws from "@pulumi/aws";

export interface NatGatewayArgs {
  environment: string;
  natName?: string;
  connectivityType?: string;
  subnetId: pulumi.Input<string>;
}

export class NatGateway extends pulumi.ComponentResource {
  public readonly id: pulumi.Output<string>;
  public readonly publicIp: pulumi.Output<string | undefined>;

  constructor(name: string, args: NatGatewayArgs, opts?: pulumi.ComponentResourceOptions) {
    super("archyra:aws:NatGateway", name, {}, opts);

    const isPublic = (args.connectivityType || "public") === "public";

    let eip: aws.ec2.Eip | undefined;
    if (isPublic) {
      eip = new aws.ec2.Eip(\`\${name}-eip\`, {
        domain: "vpc",
        tags: {
          Name: \`\${name}-eip\`,
          Environment: args.environment,
        },
      }, { parent: this });
    }

    const nat = new aws.ec2.NatGateway(\`\${name}-nat\`, {
      allocationId: eip?.id,
      connectivityType: args.connectivityType || "public",
      subnetId: args.subnetId,
      tags: {
        Name: args.natName || name,
        Environment: args.environment,
      },
    }, { parent: this });

    this.id = nat.id;
    this.publicIp = eip?.publicIp;

    this.registerOutputs({
      id: this.id,
      publicIp: this.publicIp,
    });
  }
}
`;
}

function generateReadme(nodes: Node<ServiceNodeData>[], language: PulumiLanguage = 'typescript'): string {
  const services = nodes.map((n) => `- ${n.data.serviceName} (${n.data.serviceId})`).join('\n');

  if (language === 'python') {
    return `# Infrastructure as Code - Generated by Archyra

## Overview

This Pulumi Python configuration was generated by Archyra Architecture Designer.

## Resources

${services}

## Prerequisites

1. Install Pulumi CLI: https://www.pulumi.com/docs/install/
2. Configure AWS credentials
3. Install Python 3.8+

## Usage

1. Create and activate a virtual environment:
   \`\`\`bash
   python -m venv venv
   source venv/bin/activate  # On Windows: venv\\Scripts\\activate
   \`\`\`

2. Install dependencies:
   \`\`\`bash
   pip install -r requirements.txt
   \`\`\`

3. Create a new stack:
   \`\`\`bash
   pulumi stack init dev
   \`\`\`

4. Set configuration (if needed):
   \`\`\`bash
   pulumi config set aws:region us-east-1
   pulumi config set --secret dbPassword "your-password"
   \`\`\`

5. Preview the changes:
   \`\`\`bash
   pulumi preview
   \`\`\`

6. Deploy the infrastructure:
   \`\`\`bash
   pulumi up
   \`\`\`

## Structure

\`\`\`
 __main__.py        # Main entry point
 Pulumi.yaml        # Project configuration
 requirements.txt   # Python dependencies
 README.md          # This file
 components/        # Reusable component classes
     __init__.py
     ec2.py
     s3.py
     rds.py
     ...
\`\`\`

## Important Notes

- Review and customize the generated code before deploying
- Set sensitive values using \`pulumi config set --secret\`
- Consider using Pulumi Cloud for state management and collaboration

## Generated

Date: ${new Date().toISOString()}
Tool: Archyra Architecture Designer
`;
  }

  return `# Infrastructure as Code - Generated by Archyra

## Overview

This Pulumi TypeScript configuration was generated by Archyra Architecture Designer.

## Resources

${services}

## Prerequisites

1. Install Pulumi CLI: https://www.pulumi.com/docs/install/
2. Configure AWS credentials
3. Install Node.js 18+

## Usage

1. Install dependencies:
   \`\`\`bash
   npm install
   \`\`\`

2. Create a new stack:
   \`\`\`bash
   pulumi stack init dev
   \`\`\`

3. Set configuration (if needed):
   \`\`\`bash
   pulumi config set aws:region us-east-1
   pulumi config set --secret dbPassword "your-password"
   \`\`\`

4. Preview the changes:
   \`\`\`bash
   pulumi preview
   \`\`\`

5. Deploy the infrastructure:
   \`\`\`bash
   pulumi up
   \`\`\`

## Structure

\`\`\`
 index.ts           # Main entry point
 Pulumi.yaml        # Project configuration
 package.json       # Node.js dependencies
 tsconfig.json      # TypeScript configuration
 README.md          # This file
 components/        # Reusable component classes
     ec2.ts
     s3.ts
     rds.ts
     ...
\`\`\`

## Important Notes

- Review and customize the generated code before deploying
- Set sensitive values using \`pulumi config set --secret\`
- Consider using Pulumi Cloud for state management and collaboration

## Generated

Date: ${new Date().toISOString()}
Tool: Archyra Architecture Designer
`;
}

// ============================================
// Python-specific generators
// ============================================

function generatePulumiYamlPython(): string {
  return `name: archyra-infrastructure
runtime: python
description: Infrastructure generated by Archyra Architecture Designer

config:
  aws:region:
    default: us-east-1
`;
}

function generateRequirementsTxt(): string {
  return `pulumi>=3.0.0
pulumi-aws>=6.0.0
`;
}

function getPythonFilename(serviceId: string): string {
  const filenames: Record<string, string> = {
    'lambda': 'lambda_func',
    'api-gateway': 'api_gateway',
  };
  return filenames[serviceId] || serviceId.replace(/-/g, '_');
}

function getPythonClassName(serviceId: string): string {
  const classNames: Record<string, string> = {
    ec2: 'Ec2Instance',
    lambda: 'LambdaFunction',
    s3: 'S3Bucket',
    rds: 'RdsDatabase',
    dynamodb: 'DynamoDbTable',
    'api-gateway': 'ApiGateway',
    cloudfront: 'CloudFrontDistribution',
    sqs: 'SqsQueue',
    sns: 'SnsTopic',
    cognito: 'CognitoUserPool',
    vpc: 'Vpc',
    ecs: 'EcsCluster',
    elasticache: 'ElastiCacheCluster',
    iam: 'IamRole',
    route53: 'Route53Zone',
  };
  return classNames[serviceId] || toPascalCase(serviceId);
}

function generatePythonComponentInit(serviceTypes: string[]): string {
  const imports = serviceTypes.map((serviceId) => {
    const filename = getPythonFilename(serviceId);
    const className = getPythonClassName(serviceId);
    return `from .${filename} import ${className}`;
  }).join('\n');

  return `# Auto-generated component exports
${imports}
`;
}

function generatePythonMain(
  nodes: Node<ServiceNodeData>[],
  edges: Edge[]
): string {
  const serviceTypes = new Set(nodes.map((n) => n.data.serviceId));
  const imports: string[] = [];
  const instantiations: string[] = [];
  const exports: string[] = [];

  // Add imports
  imports.push(`import pulumi`);
  imports.push(`from pulumi import Config, export`);

  serviceTypes.forEach((serviceId) => {
    const filename = getPythonFilename(serviceId);
    const className = getPythonClassName(serviceId);
    imports.push(`from components.${filename} import ${className}`);
  });

  // Add config
  instantiations.push(`
# Configuration
config = Config()
environment = config.get("environment") or "production"
`);

  // Add instantiations
  nodes.forEach((node) => {
    const resourceName = sanitizeName(node.data.serviceName);
    const className = getPythonClassName(node.data.serviceId);
    const propsString = generatePythonPropsObject(node);

    instantiations.push(`# ${node.data.serviceName}
${resourceName} = ${className}("${resourceName}",
    environment=environment,
${propsString})`);

    exports.push(`export("${resourceName}_id", ${resourceName}.id)`);
  });

  return `# Generated by Archyra Architecture Designer
# Pulumi Python Configuration

${imports.join('\n')}
${instantiations.join('\n\n')}

# Exports
${exports.join('\n')}
`;
}

function generatePythonPropsObject(node: Node<ServiceNodeData>): string {
  const props = node.data.properties;
  const lines: string[] = [];

  Object.entries(props).forEach(([key, value]) => {
    if (value !== '' && value !== undefined && value !== null) {
      const snakeKey = key.replace(/([A-Z])/g, '_$1').toLowerCase().replace(/^_/, '');
      if (typeof value === 'string') {
        lines.push(`    ${snakeKey}="${value}",`);
      } else if (typeof value === 'boolean') {
        lines.push(`    ${snakeKey}=${value ? 'True' : 'False'},`);
      } else if (typeof value === 'number') {
        lines.push(`    ${snakeKey}=${value},`);
      }
    }
  });

  return lines.join('\n');
}

function generatePythonComponentFile(serviceId: string): string {
  switch (serviceId) {
    case 'ec2':
      return generatePythonEc2Component();
    case 'lambda':
      return generatePythonLambdaComponent();
    case 's3':
      return generatePythonS3Component();
    case 'rds':
      return generatePythonRdsComponent();
    case 'dynamodb':
      return generatePythonDynamoDbComponent();
    case 'api-gateway':
      return generatePythonApiGatewayComponent();
    case 'cloudfront':
      return generatePythonCloudFrontComponent();
    case 'sqs':
      return generatePythonSqsComponent();
    case 'sns':
      return generatePythonSnsComponent();
    case 'cognito':
      return generatePythonCognitoComponent();
    case 'vpc':
      return generatePythonVpcComponent();
    case 'ecs':
      return generatePythonEcsComponent();
    case 'elasticache':
      return generatePythonElastiCacheComponent();
    case 'iam':
      return generatePythonIamComponent();
    case 'route53':
      return generatePythonRoute53Component();
    default:
      return `# TODO: Add ${serviceId} component\n`;
  }
}

function generatePythonEc2Component(): string {
  return `# EC2 Instance Component
import pulumi
import pulumi_aws as aws
from typing import Optional

class Ec2Instance(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 instance_name: Optional[str] = None,
                 instance_type: str = "t3.micro",
                 ami: str = "amazon-linux-2023",
                 root_volume_size: int = 30,
                 root_volume_type: str = "gp3",
                 public_ip: bool = True,
                 key_pair: Optional[str] = None,
                 monitoring: bool = False,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:Ec2Instance", name, None, opts)

        ami_filter = {
            "amazon-linux-2023": "al2023-ami-*-x86_64",
            "amazon-linux-2": "amzn2-ami-hvm-*-x86_64-gp2",
            "ubuntu-24": "ubuntu/images/hvm-ssd/ubuntu-noble-24.04-amd64-server-*",
            "ubuntu-22": "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*",
        }.get(ami, "al2023-ami-*-x86_64")

        ami_lookup = aws.ec2.get_ami(
            most_recent=True,
            owners=["amazon"],
            filters=[{"name": "name", "values": [ami_filter]}]
        )

        instance = aws.ec2.Instance(f"{name}-instance",
            ami=ami_lookup.id,
            instance_type=instance_type,
            root_block_device=aws.ec2.InstanceRootBlockDeviceArgs(
                volume_size=root_volume_size,
                volume_type=root_volume_type,
                encrypted=True,
            ),
            associate_public_ip_address=public_ip,
            key_name=key_pair,
            monitoring=monitoring,
            tags={
                "Name": instance_name or name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        self.id = instance.id
        self.public_ip = instance.public_ip
        self.private_ip = instance.private_ip

        self.register_outputs({
            "id": self.id,
            "public_ip": self.public_ip,
            "private_ip": self.private_ip,
        })
`;
}

function generatePythonLambdaComponent(): string {
  return `# Lambda Function Component
import pulumi
import pulumi_aws as aws
import json
from typing import Optional

class LambdaFunction(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 function_name: Optional[str] = None,
                 runtime: str = "python3.12",
                 handler: str = "lambda_function.handler",
                 memory: int = 256,
                 timeout: int = 30,
                 architecture: str = "arm64",
                 reserved_concurrency: int = -1,
                 env_vars: Optional[str] = None,
                 enable_tracing: bool = False,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:LambdaFunction", name, None, opts)

        role = aws.iam.Role(f"{name}-role",
            assume_role_policy=json.dumps({
                "Version": "2012-10-17",
                "Statement": [{
                    "Action": "sts:AssumeRole",
                    "Effect": "Allow",
                    "Principal": {"Service": "lambda.amazonaws.com"},
                }],
            }),
            opts=pulumi.ResourceOptions(parent=self)
        )

        aws.iam.RolePolicyAttachment(f"{name}-policy",
            role=role.name,
            policy_arn="arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
            opts=pulumi.ResourceOptions(parent=self)
        )

        env_variables = {"ENVIRONMENT": environment}
        if env_vars:
            for line in env_vars.split("\\n"):
                if "=" in line:
                    key, value = line.split("=", 1)
                    env_variables[key.strip()] = value.strip()

        lambda_code = '''
def handler(event, context):
    return {"statusCode": 200, "body": "Hello from Lambda!"}
'''

        lambda_function = aws.lambda_.Function(f"{name}-function",
            name=function_name or name,
            role=role.arn,
            handler=handler,
            runtime=runtime,
            memory_size=memory,
            timeout=timeout,
            architectures=[architecture],
            reserved_concurrent_executions=reserved_concurrency if reserved_concurrency >= 0 else None,
            code=pulumi.AssetArchive({
                "lambda_function.py": pulumi.StringAsset(lambda_code),
            }),
            environment=aws.lambda_.FunctionEnvironmentArgs(
                variables=env_variables,
            ),
            tracing_config=aws.lambda_.FunctionTracingConfigArgs(
                mode="Active" if enable_tracing else "PassThrough",
            ),
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        self.id = lambda_function.id
        self.arn = lambda_function.arn
        self.invoke_arn = lambda_function.invoke_arn

        self.register_outputs({
            "id": self.id,
            "arn": self.arn,
            "invoke_arn": self.invoke_arn,
        })
`;
}

function generatePythonS3Component(): string {
  return `# S3 Bucket Component
import pulumi
import pulumi_aws as aws
from typing import Optional

class S3Bucket(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 bucket_name: str,
                 versioning: bool = False,
                 encryption: str = "AES256",
                 public_access: bool = True,
                 static_hosting: bool = False,
                 index_document: str = "index.html",
                 error_document: str = "error.html",
                 lifecycle_enabled: bool = False,
                 transition_days: int = 30,
                 expiration_days: int = 0,
                 enable_cors: bool = False,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:S3Bucket", name, None, opts)

        bucket = aws.s3.Bucket(f"{name}-bucket",
            bucket=bucket_name,
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        aws.s3.BucketVersioningV2(f"{name}-versioning",
            bucket=bucket.id,
            versioning_configuration=aws.s3.BucketVersioningV2VersioningConfigurationArgs(
                status="Enabled" if versioning else "Suspended",
            ),
            opts=pulumi.ResourceOptions(parent=self)
        )

        if encryption and encryption != "none":
            aws.s3.BucketServerSideEncryptionConfigurationV2(f"{name}-encryption",
                bucket=bucket.id,
                rules=[aws.s3.BucketServerSideEncryptionConfigurationV2RuleArgs(
                    apply_server_side_encryption_by_default=aws.s3.BucketServerSideEncryptionConfigurationV2RuleApplyServerSideEncryptionByDefaultArgs(
                        sse_algorithm="aws:kms" if encryption == "aws:kms" else "AES256",
                    ),
                )],
                opts=pulumi.ResourceOptions(parent=self)
            )

        aws.s3.BucketPublicAccessBlock(f"{name}-public-access",
            bucket=bucket.id,
            block_public_acls=public_access,
            block_public_policy=public_access,
            ignore_public_acls=public_access,
            restrict_public_buckets=public_access,
            opts=pulumi.ResourceOptions(parent=self)
        )

        if static_hosting:
            aws.s3.BucketWebsiteConfigurationV2(f"{name}-website",
                bucket=bucket.id,
                index_document=aws.s3.BucketWebsiteConfigurationV2IndexDocumentArgs(
                    suffix=index_document,
                ),
                error_document=aws.s3.BucketWebsiteConfigurationV2ErrorDocumentArgs(
                    key=error_document,
                ),
                opts=pulumi.ResourceOptions(parent=self)
            )

        if lifecycle_enabled:
            aws.s3.BucketLifecycleConfigurationV2(f"{name}-lifecycle",
                bucket=bucket.id,
                rules=[aws.s3.BucketLifecycleConfigurationV2RuleArgs(
                    id="lifecycle-rule",
                    status="Enabled",
                    transitions=[aws.s3.BucketLifecycleConfigurationV2RuleTransitionArgs(
                        days=transition_days,
                        storage_class="STANDARD_IA",
                    )],
                    expiration=aws.s3.BucketLifecycleConfigurationV2RuleExpirationArgs(
                        days=expiration_days,
                    ) if expiration_days > 0 else None,
                )],
                opts=pulumi.ResourceOptions(parent=self)
            )

        if enable_cors:
            aws.s3.BucketCorsConfigurationV2(f"{name}-cors",
                bucket=bucket.id,
                cors_rules=[aws.s3.BucketCorsConfigurationV2CorsRuleArgs(
                    allowed_headers=["*"],
                    allowed_methods=["GET", "HEAD", "PUT", "POST", "DELETE"],
                    allowed_origins=["*"],
                    max_age_seconds=3000,
                )],
                opts=pulumi.ResourceOptions(parent=self)
            )

        self.id = bucket.id
        self.arn = bucket.arn
        self.bucket_domain_name = bucket.bucket_regional_domain_name

        self.register_outputs({
            "id": self.id,
            "arn": self.arn,
            "bucket_domain_name": self.bucket_domain_name,
        })
`;
}

function generatePythonRdsComponent(): string {
  return `# RDS Database Component
import pulumi
import pulumi_aws as aws
from pulumi import Config
from typing import Optional

class RdsDatabase(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 identifier: str,
                 engine: str = "postgres",
                 instance_class: str = "db.t3.micro",
                 allocated_storage: int = 20,
                 max_allocated_storage: int = 100,
                 storage_type: str = "gp3",
                 db_name: str = "mydb",
                 master_username: str = "admin",
                 port: int = 5432,
                 multi_az: bool = False,
                 publicly_accessible: bool = False,
                 backup_retention: int = 7,
                 deletion_protection: bool = True,
                 performance_insights: bool = False,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:RdsDatabase", name, None, opts)

        config = Config()
        password = config.require_secret("dbPassword")

        engine_version = None
        if engine == "postgres":
            engine_version = "16"
        elif engine == "mysql":
            engine_version = "8.0"

        instance = aws.rds.Instance(f"{name}-db",
            identifier=identifier,
            engine=engine,
            engine_version=engine_version,
            instance_class=instance_class,
            allocated_storage=allocated_storage,
            max_allocated_storage=max_allocated_storage,
            storage_type=storage_type,
            storage_encrypted=True,
            db_name=db_name,
            username=master_username,
            password=password,
            port=port,
            multi_az=multi_az,
            publicly_accessible=publicly_accessible,
            backup_retention_period=backup_retention,
            deletion_protection=deletion_protection,
            skip_final_snapshot=not deletion_protection,
            performance_insights_enabled=performance_insights,
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        self.id = instance.id
        self.endpoint = instance.endpoint
        self.port = instance.port

        self.register_outputs({
            "id": self.id,
            "endpoint": self.endpoint,
            "port": self.port,
        })
`;
}

function generatePythonDynamoDbComponent(): string {
  return `# DynamoDB Table Component
import pulumi
import pulumi_aws as aws
from typing import Optional, List

class DynamoDbTable(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 table_name: str,
                 billing_mode: str = "PAY_PER_REQUEST",
                 hash_key: str = "id",
                 hash_key_type: str = "S",
                 range_key: Optional[str] = None,
                 range_key_type: str = "S",
                 read_capacity: int = 5,
                 write_capacity: int = 5,
                 enable_streams: bool = False,
                 stream_view_type: str = "NEW_AND_OLD_IMAGES",
                 ttl_attribute: Optional[str] = None,
                 point_in_time_recovery: bool = False,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:DynamoDbTable", name, None, opts)

        attributes = [aws.dynamodb.TableAttributeArgs(
            name=hash_key,
            type=hash_key_type,
        )]

        if range_key:
            attributes.append(aws.dynamodb.TableAttributeArgs(
                name=range_key,
                type=range_key_type,
            ))

        table = aws.dynamodb.Table(f"{name}-table",
            name=table_name,
            billing_mode=billing_mode,
            hash_key=hash_key,
            range_key=range_key,
            attributes=attributes,
            read_capacity=read_capacity if billing_mode == "PROVISIONED" else None,
            write_capacity=write_capacity if billing_mode == "PROVISIONED" else None,
            stream_enabled=enable_streams,
            stream_view_type=stream_view_type if enable_streams else None,
            ttl=aws.dynamodb.TableTtlArgs(
                attribute_name=ttl_attribute,
                enabled=True,
            ) if ttl_attribute else None,
            point_in_time_recovery=aws.dynamodb.TablePointInTimeRecoveryArgs(
                enabled=point_in_time_recovery,
            ),
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        self.id = table.id
        self.arn = table.arn

        self.register_outputs({
            "id": self.id,
            "arn": self.arn,
        })
`;
}

function generatePythonApiGatewayComponent(): string {
  return `# API Gateway Component
import pulumi
import pulumi_aws as aws
import json
from typing import Optional

class ApiGateway(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 api_name: str,
                 api_type: str = "HTTP",
                 stage_name: str = "prod",
                 cors_enabled: bool = False,
                 cors_origins: str = "*",
                 throttling_burst_limit: int = 5000,
                 throttling_rate_limit: int = 10000,
                 enable_access_logs: bool = False,
                 enable_x_ray: bool = False,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:ApiGateway", name, None, opts)

        cors_config = None
        if cors_enabled:
            cors_config = aws.apigatewayv2.ApiCorsConfigurationArgs(
                allow_origins=cors_origins.split(","),
                allow_methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"],
                allow_headers=["*"],
            )

        api = aws.apigatewayv2.Api(f"{name}-api",
            name=api_name,
            protocol_type=api_type,
            cors_configuration=cors_config,
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        log_group = None
        if enable_access_logs:
            log_group = aws.cloudwatch.LogGroup(f"{name}-logs",
                name=f"/aws/apigateway/{name}",
                opts=pulumi.ResourceOptions(parent=self)
            )

        access_log_settings = None
        if log_group:
            access_log_settings = aws.apigatewayv2.StageAccessLogSettingsArgs(
                destination_arn=log_group.arn,
                format=json.dumps({
                    "requestId": "$context.requestId",
                    "ip": "$context.identity.sourceIp",
                    "requestTime": "$context.requestTime",
                    "httpMethod": "$context.httpMethod",
                    "routeKey": "$context.routeKey",
                    "status": "$context.status",
                    "responseLength": "$context.responseLength",
                }),
            )

        stage = aws.apigatewayv2.Stage(f"{name}-stage",
            api_id=api.id,
            name=stage_name,
            auto_deploy=True,
            default_route_settings=aws.apigatewayv2.StageDefaultRouteSettingsArgs(
                throttling_burst_limit=throttling_burst_limit,
                throttling_rate_limit=throttling_rate_limit,
            ),
            access_log_settings=access_log_settings,
            opts=pulumi.ResourceOptions(parent=self)
        )

        self.id = api.id
        self.endpoint = stage.invoke_url

        self.register_outputs({
            "id": self.id,
            "endpoint": self.endpoint,
        })
`;
}

function generatePythonCloudFrontComponent(): string {
  return `# CloudFront Distribution Component
import pulumi
import pulumi_aws as aws
from typing import Optional

class CloudFrontDistribution(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 comment: str = "My Distribution",
                 price_class: str = "PriceClass_100",
                 default_root_object: str = "index.html",
                 default_ttl: int = 86400,
                 max_ttl: int = 31536000,
                 min_ttl: int = 0,
                 viewer_protocol: str = "redirect-to-https",
                 enable_compression: bool = True,
                 enable_waf: bool = False,
                 enable_logging: bool = False,
                 origin_domain_name: str = "example.com",
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:CloudFrontDistribution", name, None, opts)

        distribution = aws.cloudfront.Distribution(f"{name}-distribution",
            enabled=True,
            comment=comment,
            default_root_object=default_root_object,
            price_class=price_class,
            origins=[aws.cloudfront.DistributionOriginArgs(
                domain_name=origin_domain_name,
                origin_id="primary",
                custom_origin_config=aws.cloudfront.DistributionOriginCustomOriginConfigArgs(
                    http_port=80,
                    https_port=443,
                    origin_protocol_policy="https-only",
                    origin_ssl_protocols=["TLSv1.2"],
                ),
            )],
            default_cache_behavior=aws.cloudfront.DistributionDefaultCacheBehaviorArgs(
                allowed_methods=["GET", "HEAD", "OPTIONS", "PUT", "POST", "PATCH", "DELETE"],
                cached_methods=["GET", "HEAD"],
                target_origin_id="primary",
                viewer_protocol_policy=viewer_protocol,
                compress=enable_compression,
                min_ttl=min_ttl,
                default_ttl=default_ttl,
                max_ttl=max_ttl,
                forwarded_values=aws.cloudfront.DistributionDefaultCacheBehaviorForwardedValuesArgs(
                    query_string=True,
                    cookies=aws.cloudfront.DistributionDefaultCacheBehaviorForwardedValuesCookiesArgs(
                        forward="none",
                    ),
                ),
            ),
            restrictions=aws.cloudfront.DistributionRestrictionsArgs(
                geo_restriction=aws.cloudfront.DistributionRestrictionsGeoRestrictionArgs(
                    restriction_type="none",
                ),
            ),
            viewer_certificate=aws.cloudfront.DistributionViewerCertificateArgs(
                cloudfront_default_certificate=True,
            ),
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        self.id = distribution.id
        self.domain_name = distribution.domain_name

        self.register_outputs({
            "id": self.id,
            "domain_name": self.domain_name,
        })
`;
}

function generatePythonSqsComponent(): string {
  return `# SQS Queue Component
import pulumi
import pulumi_aws as aws
import json
from typing import Optional

class SqsQueue(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 queue_name: str,
                 fifo_queue: bool = False,
                 content_based_dedup: bool = False,
                 visibility_timeout: int = 30,
                 message_retention: int = 345600,
                 max_message_size: int = 262144,
                 delay_seconds: int = 0,
                 receive_wait_time: int = 0,
                 enable_dlq: bool = False,
                 max_receive_count: int = 3,
                 enable_encryption: bool = True,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:SqsQueue", name, None, opts)

        actual_queue_name = f"{queue_name}.fifo" if fifo_queue else queue_name

        dlq = None
        if enable_dlq:
            dlq_name = f"{queue_name}-dlq.fifo" if fifo_queue else f"{queue_name}-dlq"
            dlq = aws.sqs.Queue(f"{name}-dlq",
                name=dlq_name,
                fifo_queue=fifo_queue,
                tags={
                    "Name": f"{name}-dlq",
                    "Environment": environment,
                },
                opts=pulumi.ResourceOptions(parent=self)
            )

        redrive_policy = None
        if dlq:
            redrive_policy = dlq.arn.apply(lambda arn: json.dumps({
                "deadLetterTargetArn": arn,
                "maxReceiveCount": max_receive_count,
            }))

        queue = aws.sqs.Queue(f"{name}-queue",
            name=actual_queue_name,
            fifo_queue=fifo_queue,
            content_based_deduplication=content_based_dedup if fifo_queue else None,
            visibility_timeout_seconds=visibility_timeout,
            message_retention_seconds=message_retention,
            max_message_size=max_message_size,
            delay_seconds=delay_seconds,
            receive_wait_time_seconds=receive_wait_time,
            sqs_managed_sse_enabled=enable_encryption,
            redrive_policy=redrive_policy,
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        self.id = queue.id
        self.arn = queue.arn
        self.url = queue.url

        self.register_outputs({
            "id": self.id,
            "arn": self.arn,
            "url": self.url,
        })
`;
}

function generatePythonSnsComponent(): string {
  return `# SNS Topic Component
import pulumi
import pulumi_aws as aws
from typing import Optional

class SnsTopic(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 topic_name: str,
                 display_name: Optional[str] = None,
                 fifo_topic: bool = False,
                 content_based_dedup: bool = False,
                 kms_master_key_id: Optional[str] = None,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:SnsTopic", name, None, opts)

        actual_topic_name = f"{topic_name}.fifo" if fifo_topic else topic_name

        topic = aws.sns.Topic(f"{name}-topic",
            name=actual_topic_name,
            display_name=display_name,
            fifo_topic=fifo_topic,
            content_based_deduplication=content_based_dedup if fifo_topic else None,
            kms_master_key_id=kms_master_key_id,
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        self.id = topic.id
        self.arn = topic.arn

        self.register_outputs({
            "id": self.id,
            "arn": self.arn,
        })
`;
}

function generatePythonCognitoComponent(): string {
  return `# Cognito User Pool Component
import pulumi
import pulumi_aws as aws
from typing import Optional

class CognitoUserPool(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 pool_name: str,
                 mfa_configuration: str = "OPTIONAL",
                 username_attributes: str = "email",
                 auto_verified_attributes: str = "email",
                 password_min_length: int = 8,
                 password_require_uppercase: bool = True,
                 password_require_lowercase: bool = True,
                 password_require_numbers: bool = True,
                 password_require_symbols: bool = True,
                 allow_admin_user_creation: bool = False,
                 email_verification_message: str = "Your verification code is {####}",
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:CognitoUserPool", name, None, opts)

        user_pool = aws.cognito.UserPool(f"{name}-pool",
            name=pool_name,
            mfa_configuration=mfa_configuration,
            username_attributes=[username_attributes],
            auto_verified_attributes=[auto_verified_attributes],
            password_policy=aws.cognito.UserPoolPasswordPolicyArgs(
                minimum_length=password_min_length,
                require_uppercase=password_require_uppercase,
                require_lowercase=password_require_lowercase,
                require_numbers=password_require_numbers,
                require_symbols=password_require_symbols,
            ),
            admin_create_user_config=aws.cognito.UserPoolAdminCreateUserConfigArgs(
                allow_admin_create_user_only=allow_admin_user_creation,
            ),
            verification_message_template=aws.cognito.UserPoolVerificationMessageTemplateArgs(
                default_email_option="CONFIRM_WITH_CODE",
                email_message=email_verification_message,
            ),
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        client = aws.cognito.UserPoolClient(f"{name}-client",
            name=f"{name}_client",
            user_pool_id=user_pool.id,
            generate_secret=False,
            explicit_auth_flows=[
                "ALLOW_USER_PASSWORD_AUTH",
                "ALLOW_REFRESH_TOKEN_AUTH",
                "ALLOW_USER_SRP_AUTH",
            ],
            opts=pulumi.ResourceOptions(parent=self)
        )

        self.id = user_pool.id
        self.arn = user_pool.arn
        self.client_id = client.id

        self.register_outputs({
            "id": self.id,
            "arn": self.arn,
            "client_id": self.client_id,
        })
`;
}

function generatePythonVpcComponent(): string {
  return `# VPC Component
import pulumi
import pulumi_aws as aws
from typing import Optional, List

class Vpc(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 vpc_name: Optional[str] = None,
                 cidr_block: str = "10.0.0.0/16",
                 enable_dns_hostnames: bool = True,
                 enable_dns_support: bool = True,
                 public_subnets: int = 2,
                 private_subnets: int = 2,
                 enable_nat_gateway: bool = False,
                 single_nat_gateway: bool = False,
                 enable_vpn_gateway: bool = False,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:Vpc", name, None, opts)

        azs = aws.get_availability_zones(state="available")

        vpc = aws.ec2.Vpc(f"{name}-vpc",
            cidr_block=cidr_block,
            enable_dns_hostnames=enable_dns_hostnames,
            enable_dns_support=enable_dns_support,
            tags={
                "Name": vpc_name or name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        igw = aws.ec2.InternetGateway(f"{name}-igw",
            vpc_id=vpc.id,
            tags={"Name": f"{name}-igw"},
            opts=pulumi.ResourceOptions(parent=self)
        )

        public_subnet_ids = []
        private_subnet_ids = []

        for i in range(public_subnets):
            subnet = aws.ec2.Subnet(f"{name}-public-{i}",
                vpc_id=vpc.id,
                cidr_block=f"10.0.{i}.0/24",
                availability_zone=azs.names[i % len(azs.names)],
                map_public_ip_on_launch=True,
                tags={
                    "Name": f"{name}-public-{i + 1}",
                    "Type": "public",
                },
                opts=pulumi.ResourceOptions(parent=self)
            )
            public_subnet_ids.append(subnet.id)

        for i in range(private_subnets):
            subnet = aws.ec2.Subnet(f"{name}-private-{i}",
                vpc_id=vpc.id,
                cidr_block=f"10.0.{i + public_subnets}.0/24",
                availability_zone=azs.names[i % len(azs.names)],
                tags={
                    "Name": f"{name}-private-{i + 1}",
                    "Type": "private",
                },
                opts=pulumi.ResourceOptions(parent=self)
            )
            private_subnet_ids.append(subnet.id)

        if enable_nat_gateway:
            nat_count = 1 if single_nat_gateway else public_subnets
            for i in range(nat_count):
                eip = aws.ec2.Eip(f"{name}-nat-eip-{i}",
                    domain="vpc",
                    tags={"Name": f"{name}-nat-eip-{i + 1}"},
                    opts=pulumi.ResourceOptions(parent=self)
                )

                aws.ec2.NatGateway(f"{name}-nat-{i}",
                    allocation_id=eip.id,
                    subnet_id=public_subnet_ids[i],
                    tags={"Name": f"{name}-nat-{i + 1}"},
                    opts=pulumi.ResourceOptions(parent=self)
                )

        self.id = vpc.id
        self.public_subnet_ids = public_subnet_ids
        self.private_subnet_ids = private_subnet_ids

        self.register_outputs({
            "id": self.id,
            "public_subnet_ids": self.public_subnet_ids,
            "private_subnet_ids": self.private_subnet_ids,
        })
`;
}

function generatePythonEcsComponent(): string {
  return `# ECS Cluster Component
import pulumi
import pulumi_aws as aws
import json
from typing import Optional, List

class EcsCluster(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 cluster_name: str,
                 service_name: str,
                 launch_type: str = "FARGATE",
                 cpu: str = "512",
                 memory: str = "1024",
                 desired_count: int = 2,
                 container_port: int = 80,
                 health_check_path: str = "/health",
                 enable_auto_scaling: bool = False,
                 min_capacity: int = 1,
                 max_capacity: int = 10,
                 vpc_id: Optional[str] = None,
                 subnet_ids: Optional[List[str]] = None,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:EcsCluster", name, None, opts)

        cluster = aws.ecs.Cluster(f"{name}-cluster",
            name=cluster_name,
            settings=[aws.ecs.ClusterSettingArgs(
                name="containerInsights",
                value="enabled",
            )],
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        execution_role = aws.iam.Role(f"{name}-execution-role",
            assume_role_policy=json.dumps({
                "Version": "2012-10-17",
                "Statement": [{
                    "Action": "sts:AssumeRole",
                    "Effect": "Allow",
                    "Principal": {"Service": "ecs-tasks.amazonaws.com"},
                }],
            }),
            opts=pulumi.ResourceOptions(parent=self)
        )

        aws.iam.RolePolicyAttachment(f"{name}-execution-policy",
            role=execution_role.name,
            policy_arn="arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy",
            opts=pulumi.ResourceOptions(parent=self)
        )

        log_group = aws.cloudwatch.LogGroup(f"{name}-logs",
            name=f"/ecs/{name}",
            retention_in_days=30,
            opts=pulumi.ResourceOptions(parent=self)
        )

        actual_launch_type = "FARGATE" if launch_type == "FARGATE_SPOT" else launch_type

        region = aws.get_region()

        container_definitions = log_group.name.apply(lambda log_name: json.dumps([{
            "name": service_name,
            "image": "nginx:latest",
            "essential": True,
            "portMappings": [{
                "containerPort": container_port,
                "hostPort": container_port,
                "protocol": "tcp",
            }],
            "healthCheck": {
                "command": ["CMD-SHELL", f"curl -f http://localhost{health_check_path} || exit 1"],
                "interval": 30,
                "timeout": 5,
                "retries": 3,
                "startPeriod": 60,
            },
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-group": log_name,
                    "awslogs-region": region.name,
                    "awslogs-stream-prefix": "ecs",
                },
            },
        }]))

        task_definition = aws.ecs.TaskDefinition(f"{name}-task",
            family=service_name,
            network_mode="awsvpc",
            requires_compatibilities=[actual_launch_type],
            cpu=cpu,
            memory=memory,
            execution_role_arn=execution_role.arn,
            container_definitions=container_definitions,
            tags={"Name": name},
            opts=pulumi.ResourceOptions(parent=self)
        )

        capacity_provider_strategies = None
        service_launch_type = actual_launch_type
        if launch_type == "FARGATE_SPOT":
            service_launch_type = None
            capacity_provider_strategies = [aws.ecs.ServiceCapacityProviderStrategyArgs(
                capacity_provider="FARGATE_SPOT",
                weight=1,
            )]

        service = aws.ecs.Service(f"{name}-service",
            name=service_name,
            cluster=cluster.id,
            task_definition=task_definition.arn,
            desired_count=desired_count,
            launch_type=service_launch_type,
            capacity_provider_strategies=capacity_provider_strategies,
            network_configuration=aws.ecs.ServiceNetworkConfigurationArgs(
                subnets=subnet_ids or [],
                assign_public_ip=True,
            ),
            tags={"Name": name},
            opts=pulumi.ResourceOptions(parent=self)
        )

        if enable_auto_scaling:
            aws.appautoscaling.Target(f"{name}-scaling-target",
                max_capacity=max_capacity,
                min_capacity=min_capacity,
                resource_id=pulumi.Output.all(cluster.name, service.name).apply(
                    lambda args: f"service/{args[0]}/{args[1]}"
                ),
                scalable_dimension="ecs:service:DesiredCount",
                service_namespace="ecs",
                opts=pulumi.ResourceOptions(parent=self)
            )

        self.id = cluster.id
        self.service_name = service.name

        self.register_outputs({
            "id": self.id,
            "service_name": self.service_name,
        })
`;
}

function generatePythonElastiCacheComponent(): string {
  return `# ElastiCache Cluster Component
import pulumi
import pulumi_aws as aws
from typing import Optional

class ElastiCacheCluster(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 cluster_id: str,
                 engine: str = "redis",
                 node_type: str = "cache.t3.micro",
                 num_cache_nodes: int = 1,
                 port: Optional[int] = None,
                 parameter_group_family: str = "redis7",
                 snapshot_retention: int = 0,
                 transit_encryption: bool = True,
                 at_rest_encryption: bool = True,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:ElastiCacheCluster", name, None, opts)

        actual_port = port
        if actual_port is None:
            actual_port = 11211 if engine == "memcached" else 6379

        parameter_group_map = {
            "redis7": "default.redis7",
            "redis6.x": "default.redis6.x",
        }
        parameter_group = parameter_group_map.get(parameter_group_family, "default.memcached1.6")

        cluster = aws.elasticache.Cluster(f"{name}-cache",
            cluster_id=cluster_id,
            engine=engine,
            node_type=node_type,
            num_cache_nodes=num_cache_nodes,
            port=actual_port,
            parameter_group_name=parameter_group,
            snapshot_retention_limit=snapshot_retention,
            transit_encryption_enabled=transit_encryption,
            at_rest_encryption_enabled=at_rest_encryption,
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        self.id = cluster.id
        self.cache_nodes = cluster.cache_nodes

        self.register_outputs({
            "id": self.id,
            "cache_nodes": self.cache_nodes,
        })
`;
}

function generatePythonIamComponent(): string {
  return `# IAM Role Component
import pulumi
import pulumi_aws as aws
import json
from typing import Optional

class IamRole(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 role_name: str,
                 description: Optional[str] = None,
                 assume_role_service: str = "lambda.amazonaws.com",
                 managed_policies: Optional[str] = None,
                 max_session_duration: int = 3600,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:IamRole", name, None, opts)

        role = aws.iam.Role(f"{name}-role",
            name=role_name,
            description=description,
            assume_role_policy=json.dumps({
                "Version": "2012-10-17",
                "Statement": [{
                    "Action": "sts:AssumeRole",
                    "Effect": "Allow",
                    "Principal": {"Service": assume_role_service},
                }],
            }),
            max_session_duration=max_session_duration,
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        if managed_policies:
            policies = [p.strip() for p in managed_policies.split("\\n") if p.strip()]
            for i, policy_arn in enumerate(policies):
                aws.iam.RolePolicyAttachment(f"{name}-policy-{i}",
                    role=role.name,
                    policy_arn=policy_arn,
                    opts=pulumi.ResourceOptions(parent=self)
                )

        self.id = role.id
        self.arn = role.arn

        self.register_outputs({
            "id": self.id,
            "arn": self.arn,
        })
`;
}

function generatePythonRoute53Component(): string {
  return `# Route 53 Zone Component
import pulumi
import pulumi_aws as aws
from typing import Optional

class Route53Zone(pulumi.ComponentResource):
    def __init__(self, name: str,
                 environment: str,
                 domain_name: str,
                 zone_type: str = "public",
                 comment: Optional[str] = None,
                 vpc_id: Optional[str] = None,
                 opts: Optional[pulumi.ResourceOptions] = None):
        super().__init__("archyra:aws:Route53Zone", name, None, opts)

        vpcs = None
        if zone_type == "private" and vpc_id:
            vpcs = [aws.route53.ZoneVpcArgs(vpc_id=vpc_id)]

        zone = aws.route53.Zone(f"{name}-zone",
            name=domain_name,
            comment=comment,
            vpcs=vpcs,
            tags={
                "Name": name,
                "Environment": environment,
            },
            opts=pulumi.ResourceOptions(parent=self)
        )

        self.id = zone.id
        self.name_servers = zone.name_servers

        self.register_outputs({
            "id": self.id,
            "name_servers": self.name_servers,
        })
`;
}
